name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'  # Use stable version
        channel: 'stable'
        cache: true
        
    - name: Get Dependencies
      run: flutter pub get
      
    - name: Run Tests
      run: flutter test
      continue-on-error: true  # Don't fail deployment if tests fail
      
    - name: Analyze Code
      run: flutter analyze --fatal-infos
      continue-on-error: true  # Don't fail deployment for analysis warnings
      
    - name: Build Web App
      run: flutter build web --release --web-renderer canvaskit --dart-define=FLUTTER_WEB_USE_SKIA=true
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Deploy to Firebase
      run: firebase deploy --only hosting --project calcium-ratio-472014-r9 --token "${{ secrets.FIREBASE_TOKEN }}"
      env:
        FIREBASE_PROJECT: calcium-ratio-472014-r9
        
    - name: Comment PR with Preview URL
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸš€ **Deployment Preview**: https://calcium-ratio-472014-r9.web.app\n\nðŸ“± **Mobile Preview**: https://calcium-ratio-472014-r9.web.app\n\nâœ… Build completed successfully!'
          })