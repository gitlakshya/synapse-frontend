name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.3'
        channel: 'stable'
        cache: true
        
    - name: Get Dependencies
      run: flutter pub get
      
    - name: Analyze Code
      run: flutter analyze --no-fatal-infos
      continue-on-error: true
      
    - name: Run Tests
      run: flutter test
      continue-on-error: true
      
    - name: Build Web App
      env:
        BACKEND_API_URL: https://synapse-backend-80902795823.asia-south2.run.app
        FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID || '1:80902795823:web:07e68e2ea360ad68b0ccda' }}
        FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID || '80902795823' }}
        FIREBASE_PROJECT_ID: calcium-ratio-472014-r9
        GOOGLE_SIGNIN_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID || '80902795823-0peak8l1jm8jn0mcchcaik7n33mcnsdg.apps.googleusercontent.com' }}
        GOOGLE_MAPS_API_KEY: AIzaSyDtOV162bzCWFOsjJHEs5IvRXNr0aebhLQ
        OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY || '' }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || '' }}
      run: |
        flutter build web --release \
          --dart-define=BACKEND_API_URL=$BACKEND_API_URL \
          --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
          --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
          --dart-define=FIREBASE_MESSAGING_SENDER_ID=$FIREBASE_MESSAGING_SENDER_ID \
          --dart-define=FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID \
          --dart-define=GOOGLE_SIGNIN_CLIENT_ID=$GOOGLE_SIGNIN_CLIENT_ID \
          --dart-define=GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY \
          --dart-define=OPENWEATHER_API_KEY=$OPENWEATHER_API_KEY \
          --dart-define=GEMINI_API_KEY=$GEMINI_API_KEY
      
    - name: Deploy to Firebase Hosting
      continue-on-error: true
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CALCIUM_RATIO_472014_R9 }}
        channelId: live
        projectId: calcium-ratio-472014-r9
        
    - name: Deployment Status
      if: failure()
      run: |
        echo "‚ö†Ô∏è Firebase deployment failed or was skipped."
        echo "üìù If FIREBASE_SERVICE_ACCOUNT_CALCIUM_RATIO_472014_R9 secret is not configured, this is expected."
          
  notify:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment Success Notification
      if: needs.build-and-deploy.result == 'success'
      run: |
        echo "‚úÖ Deployment successful to Firebase Hosting"
        echo "üåê Live at: https://calcium-ratio-472014-r9.web.app"
        
    - name: Deployment Failure Notification
      if: needs.build-and-deploy.result == 'failure'
      run: |
        echo "‚ùå Deployment failed"
        echo "Check the logs above for details"
